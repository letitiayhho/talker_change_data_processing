---
title: "Permutation test"
author: "Letitia Ho"
date: "10/30/2020"
output: html_document
fig_width: 6
fig_height: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=12, fig.height=2)
library("dplyr")
library("ggplot2")
library("ggpubr")
library("kableExtra")
```

```{r load_data, include=FALSE}
setwd("/Users/letitiaho/src/talker_change_data_processing")
original <- read.csv('data/aggregate/maximum.csv')
shuffled <- read.csv('data/aggregate/shuffled_maximum.csv')
```

```{r functions, include=FALSE}
subset <- function(data, channel, level, shuffle_number = NULL) {
  column_heading <- paste("mean_", channel, sep = "")
  subset <- data[[column_heading]][data$condition == level]
  ifelse(is.null(shuffle_number), 
         yes = data[[column_heading]][data$condition == level],
         no = data[[column_heading]][(data$condition == level) & (data$shuffle_number == shuffle_number)])
}

plot_level <- function(shuffled, original, channel_number, condition_code, title) {
  shuffled_values <- subset(shuffled, channel_number, condition_code)
  original_value <- subset(original, channel_number, condition_code)
  ggplot(data.frame(shuffled_values), aes(x = shuffled_values)) +
    geom_histogram(bins = 10) +
    geom_vline(xintercept = original_value, color ='firebrick2', size = 2) +
    ggtitle(title)
}

plot_all_levels <- function(same_talker, different_talker, 
                                meaningful, nonsense,
                                low_constraint, high_constraint) {
  ggarrange(same_talker, different_talker, 
            meaningful, nonsense,
            low_constraint, high_constraint,
            ncol = 6, nrow = 1)
}

plot_channel <- function(shuffled, original, channel_number) {
  same_talker <- plot_level(shuffled, original, channel_number, "S", 
                            paste(channel_number, ": Same Talker", sep = ""))
  different_talker <- plot_level(shuffled, original, channel_number, "T",
                            paste(channel_number, ": Different Talker", sep = ""))
  meaningful <- plot_level(shuffled, original, channel_number, "M",
                            paste(channel_number, ": Meaningful", sep = ""))
  nonsense <- plot_level(shuffled, original, channel_number, "N",
                            paste(channel_number, ": Nonsense", sep = ""))
  low_constraint <- plot_level(shuffled, original, channel_number, "L",
                            paste(channel_number, ": Low constraint", sep = ""))
  high_constraint <- plot_level(shuffled, original, channel_number, "H",
                            paste(channel_number, ": High constraint", sep = ""))
  
  plot_all_levels(same_talker, different_talker, 
                  meaningful, nonsense,
                  low_constraint, high_constraint)
}

get_proportion <- function(shuffled, original, channel_number, condition_code) {
  shuffled_values <- subset(shuffled, channel_number, condition_code)
  original_value <- subset(original, channel_number, condition_code)
  if (mean(shuffled_values) > original_value) {
      proportion <- sum(shuffled_values < original_value)/length(shuffled_values)
  } else {
      proportion <- sum(shuffled_values > original_value)/length(shuffled_values)
  }
}

get_channel_proportions <- function(shuffled, original, channel_number) {
  same_talker <- get_proportion(shuffled, original, channel_number, "S")
  different_talker <- get_proportion(shuffled, original, channel_number, "T")
  meaningful <- get_proportion(shuffled, original, channel_number, "M")
  nonsense <- get_proportion(shuffled, original, channel_number, "N")
  low_constraint <- get_proportion(shuffled, original, channel_number, "L")
  high_constraint <- get_proportion(shuffled, original, channel_number, "H")
  return(data.frame("same_talker" = same_talker,
                    "different_talker" = different_talker,
                    "meaningful" = meaningful,
                    "nonsense" = nonsense,
                    "low_constraint" = low_constraint,
                    "high_constraint" = high_constraint))
}
  
get_all_channel_proportions <- function(shuffled, original) {
  all_channel_proportions <- c()
  for (i in 1:128) {
    channel_proportions <- get_channel_proportions(shuffled, original, as.character(i))
    all_channel_proportions <- rbind(all_channel_proportions, channel_proportions)
  }
  class(all_channel_proportions)
  return(all_channel_proportions)
}

plot_graded_table <- function(data) {
  data <- mutate_if(data, is.numeric, function(x) {round(x, digits = 7)}) %>%
    mutate_if(is.numeric, function(x) {ifelse(x > 0.1,
                                              cell_spec(x, NULL),
                                              cell_spec(x, background = spec_color(x,
                                                                                   direction = 1,
                                                                                   begin = 0.65,
                                                                                   end = 1,
                                                                                   option = "B",
                                                                                   scale_from = c(0,0.1))))})
  rownames(data) <- c(1:128)
  kable(data, escape = F, row.names = T) %>%
    kable_styling(bootstrap_options = c("hover", "condensed"), full_width = F)
}

get_levels <- function(condition) {
  levels <- list(talker = c("S", "T"), meaning = c("M", "N"), constraint = c("L", "H"))
  levels[[condition]]
}

get_difference <- function(data, channel, condition, shuffle = NULL) {
  levels <- get_levels(condition)
  level_1 <- subset(shuffled, as.character(channel), levels[1], shuffle) 
  level_2 <- subset(shuffled, as.character(channel), levels[2], shuffle) 
  difference <- level_1 - level_2
}

get_differences_for_all_shuffles <- function(data, channel, condition) {
  differences <- c()
  n_shuffles <- nrow(data)/6
  for (shuffle in 1:n_shuffles) {
    difference <- get_difference(data, channel, condition, shuffle)
    differences <- c(differences, difference)
  }
  return(differences)
}
```

## 1. Are there any channels that significantly track the stimuli?

To answer this question I ran a permutation test results for maximum cross correlation values across all conditions. The test was run by resampling the stimuli-eeg pairings. 208 resamplings were conducted. The average maximum cross correlation value across all participants and all condition was calculated. Some of these averages are plotted below in histograms with the observed maximum cross correlation value marked in red.

### Sample histograms of permutation test results

```{r}
# ALL I NEED TO DO RN IS AVERAGE OVER EACH SHUFFLE
```

### Proportions


## 2. Is there a condition-based difference in tracking?

To answer this question I ran a permutation test results for maximum cross correlation values in each conditions. The test was run by resampling the stimuli-eeg pairings. 208 resamplings were conducted. The average maximum cross correlation value across all participants for each condition was calculated. Some of these averages are plotted below in histograms with the observed maximum cross correlation value marked in red.

### Sample histograms of permutation test results

**First three channels**

```{r}
plot_channel(shuffled, original, "1")
plot_channel(shuffled, original, "2")
plot_channel(shuffled, original, "3")
```

**Channel 30**

```{r}
plot_channel(shuffled, original, "30")
```

### Proportions

Proportions of resampled values that are more extreme than the observed value. Reflects the probability of obtaining the observed result based on chance.

```{r}
all_channel_proportions <- get_all_channel_proportions(shuffled, original)
plot_graded_table(all_channel_proportions)
```


## 3. Which channels distinguish between levels in a condition?

```{r}
talker_original <- get_difference(original, 1, "talker")
talker <- get_differences_for_all_shuffles(shuffled, 1, "talker")
```

