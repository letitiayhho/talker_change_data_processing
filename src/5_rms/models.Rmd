---
title: "RMS models"
author: "Letitia Ho"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/letitiaho/src/talker_change_data_processing")
library(dplyr)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(rethinking)
theme_set(theme_minimal())  
```

```{r load_data, include=FALSE}
source("src/tools/functions.R")
xcorr <- read.csv('data/5_rms/maximum.csv')
rms <- read.csv('data/5_rms/rms.csv')
```

```{r}
# Simplify RMS
left_superior_parietal <- data.frame(rms$epoch_rms53, rms$epoch_rms54, rms$epoch_rms60, rms$epoch_rms61, rms$epoch_rms67) %>%
  rowMeans()
right_superior_parietal <- data.frame(rms$epoch_rms77, rms$epoch_rms78, rms$epoch_rms79, rms$epoch_rms85, rms$epoch_rms86) %>%
  rowMeans()
```

###Model for channel #40

**Clean data**
```{r}
# Create data frame
channel <- data.frame(subject_number = factor(rms$subject_number),
                       rms = left_superior_parietal,
                       xcorr = xcorr$maximum41,
                       talker = xcorr$talker,
                       meaning = xcorr$meaning,
                       constraint = xcorr$constraint,
                       subject_number = xcorr$subject_number)

# Remove rms values 3 sds above mean (below 3 sds meaningless since it's negative)
mean_rms <- mean(channel$rms)
sd_rms <- sd(channel$rms)
rms_above_3_sds <- which(channel$rms > mean_rms + sd_rms*3)
channel$rms[rms_above_3_sds] <- NA

# Remove xcorr values 3 sds above mean (below 3 sds also meaningless)
mean_xcorr <- mean(channel$xcorr)
sd_xcorr <- sd(channel$xcorr)
xcorr_above_3_sds <- which(channel$xcorr > mean_xcorr + sd_xcorr*3)
channel$xcorr[xcorr_above_3_sds] <- NA

# Change rms and xcorr to log scale
channel$log_rms <- log(channel$rms)
channel$log_xcorr <- log(channel$xcorr)

# Remove NAs
channel <- channel[complete.cases(channel),]
```

**Model with mixed effects for talker**
```{r}
# Create data frame for model 
df.ulam <- list(log_rms = channel$log_rms,
                log_xcorr = channel$log_xcorr)

# Recode talker to 1s and 2s to get link() to work
df.ulam$talker <- ifelse(channel$talker == "S", 1, 2)

# Fit model
talker_model <- ulam(
  alist(
    log_xcorr ~ dnorm(mu, sigma),
    mu <- a[talker] + b[talker]*log_rms,
    c(a, b)[talker] ~ multi_normal(c(a_bar, b_bar) , Rho , sigma_talker),
    a_bar ~ dnorm(0, 10),
    b_bar ~ dnorm(0, 10),
    sigma_talker ~ dexp(1),
    sigma ~ dexp(1),
    Rho ~ lkj_corr(2)
  ), data = df.ulam, chains = 4, cores = 4)

# Model summary
precis(talker_model, depth = 2)
```

**Plot posterior parameter predictions**
```{r}
rms_seq <- seq(from = 0, to = 3, by = 0.1)

# Extract posterior for same talker
s_mu <- link(talker_model, data = data.frame(talker = 1, log_rms = rms_seq))
s_mu_mean <- apply(s_mu, 2, mean)
s_mu_ci <- apply(s_mu, 2, PI, prob = 0.95)

# Extract posterior for different talker
t_mu <- link(talker_model, data = data.frame(talker = 2, log_rms = rms_seq))
t_mu_mean <- apply(t_mu, 2, mean)
t_mu_ci <- apply(t_mu, 2, PI, prob = 0.95)

# Generate a data frame for plotting
plot_df <- data.frame(seq = rms_seq,
                t_mu_mean = t_mu_mean,
                s_mu_mean = s_mu_mean,
                t_ci_min = t_mu_ci[1,],
                t_ci_max = t_mu_ci[2,],
                s_ci_min = s_mu_ci[1,],
                s_ci_max = s_mu_ci[2,])

# Plot
ggplot(NULL) +
  ylim(0, 8) + 
  xlim(0, 3) +
  
  # Plot raw data
  geom_point(data = channel, alpha = 0.5, stroke = 0, size = 2, aes(x = log_rms, y = log_xcorr, color = factor(talker))) +
  scale_color_manual(values = c("#2D708EFF", "#29AF7FFF")) +
  
  # Plot lines with 95% CI
  geom_line(data = plot_df, size = 0.8, color = '#20A387FF', aes(x = seq, y = t_mu_mean)) +
  geom_line(data = plot_df, size = 0.8, color = '#33638DFF', aes(x = seq, y = s_mu_mean)) +
  geom_ribbon(data = plot_df, aes(x = rms_seq, ymin = t_ci_min, ymax = t_ci_max), fill = "#29AF7FFF", alpha = 0.2) +
  geom_ribbon(data = plot_df, aes(x = rms_seq, ymin = s_ci_min, ymax = s_ci_max), fill = "#2D708EFF", alpha = 0.2) 

```
